# ============================================
# API Gateway REST API for Athena Query
# ============================================
# This Terraform configuration creates an API Gateway REST API
# with a POST /query endpoint that invokes the athena-query-student
# Lambda function.
#
# API Endpoint: POST /{stage}/query
# Integration: Lambda (athena-query-student)
# Request Format: JSON with "query" field
# Response Format: JSON with query results
# ============================================

# ============================================
# Variables
# ============================================

variable "api_name" {
  type        = string
  default     = "athena-query-api"
  description = "Name of the API Gateway REST API"
}

variable "api_description" {
  type        = string
  default     = "API Gateway for Athena SQL Query Execution"
  description = "Description of the API"
}

variable "api_stage_name" {
  type        = string
  default     = "dev"
  description = "Deployment stage name"
}

variable "lambda_function_name" {
  type        = string
  default     = "athena-query-student"
  description = "Name of the Lambda function to invoke"
}

variable "lambda_function_arn" {
  type        = string
  default     = ""
  description = "ARN of the Lambda function (optional, will be looked up if empty)"
}

variable "enable_cors" {
  type        = bool
  default     = true
  description = "Enable CORS support"
}

variable "enable_logging" {
  type        = bool
  default     = true
  description = "Enable CloudWatch logging"
}

variable "log_retention_days" {
  type        = number
  default     = 14
  description = "CloudWatch log retention in days"
}

variable "tags" {
  type        = map(string)
  default = {
    Project     = "Student-DataLake"
    Environment = "production"
    ManagedBy   = "Terraform"
    Owner       = "data-team"
    Function    = "AthenaQueryAPI"
  }
  description = "Tags to apply to all resources"
}

# ============================================
# API Gateway REST API
# ============================================

resource "aws_api_gateway_rest_api" "athena_api" {
  name        = var.api_name
  description = var.api_description
  body        = null

  # Disable automatic endpoint configuration (use regional)
  endpoint_configuration {
    types = ["REGIONAL"]
  }

  # OpenAPI specification (optional - for documentation)
  # api_key_source = "HEADER"

  tags = var.tags
}

# ============================================
# API Gateway Resource: /query
# ============================================

resource "aws_api_gateway_resource" "query_resource" {
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  parent_id   = aws_api_gateway_rest_api.athena_api.root_resource_id
  path_part   = "query"

  # Ensure API is created first
  depends_on = [aws_api_gateway_rest_api.athena_api]
}

# ============================================
# API Gateway Method: POST /query
# ============================================

resource "aws_api_gateway_method" "query_post" {
  rest_api_id   = aws_api_gateway_rest_api.athena_api.id
  resource_id   = aws_api_gateway_resource.query_resource.id
  http_method  = "POST"
  authorization = "NONE"

  # Request validation
  request_validator_id = aws_api_gateway_request_validator.body_only.id

  # API Key required (optional - enable for production)
  # api_key_required = true

  # Method settings
  operation_name = "ExecuteAthenaQuery"

  depends_on = [aws_api_gateway_resource.query_resource]
}

# ============================================
# API Gateway Request Validator
# ============================================

resource "aws_api_gateway_request_validator" "body_only" {
  rest_api_id           = aws_api_gateway_rest_api.athena_api.id
  name                  = "body-only-validator"
  validate_request_body = true
  validate_request_parameters = false
}

# ============================================
# API Gateway Request Models
# ============================================

resource "aws_api_gateway_model" "query_request" {
  rest_api_id   = aws_api_gateway_rest_api.athena_api.id
  name          = "QueryRequest"
  description   = "Request model for query execution"
  content_type  = "application/json"

  schema = jsonencode({
    "$schema"     = "http://json-schema.org/draft-04/schema#"
    type          = "object"
    title         = "Query Request"
    required      = ["query"]
    properties = {
      query = {
        type        = "string"
        description = "SQL query to execute"
        minLength   = 1
        maxLength   = 262144
      }
      maxWaitTime = {
        type        = "integer"
        description = "Maximum wait time in seconds"
        minimum     = 1
        maximum     = 900
      }
      outputLocation = {
        type        = "string"
        description = "Custom S3 output location"
      }
    }
  })

  depends_on = [aws_api_gateway_rest_api.athena_api]
}

resource "aws_api_gateway_model" "query_response" {
  rest_api_id   = aws_api_gateway_rest_api.athena_api.id
  name          = "QueryResponse"
  description   = "Response model for query results"
  content_type  = "application/json"

  schema = jsonencode({
    "$schema"     = "http://json-schema.org/draft-04/schema#"
    type          = "object"
    title         = "Query Response"
    properties = {
      message = {
        type        = "string"
        description = "Status message"
      }
      queryExecutionId = {
        type        = "string"
        description = "Athena query execution ID"
      }
      state = {
        type        = "string"
        description = "Query state (SUCCEEDED, FAILED, CANCELLED)"
      }
      rows = {
        type        = "array"
        description = "Query result rows"
        items = {
          type = "object"
        }
      }
      columnMetadata = {
        type        = "array"
        description = "Column metadata"
        items = {
          type = "object"
          properties = {
            name = { type = "string" }
            type = { type = "string" }
          }
        }
      }
      rowCount = {
        type        = "integer"
        description = "Number of rows returned"
      }
      dataScannedInBytes = {
        type        = "integer"
        description = "Amount of data scanned"
      }
      executionTimeInMillis = {
        type        = "integer"
        description = "Query execution time"
      }
    }
  })

  depends_on = [aws_api_gateway_rest_api.athena_api]
}

resource "aws_api_gateway_model" "error_response" {
  rest_api_id   = aws_api_gateway_rest_api.athena_api.id
  name          = "ErrorResponse"
  description   = "Error response model"
  content_type  = "application/json"

  schema = jsonencode({
    "$schema"     = "http://json-schema.org/draft-04/schema#"
    type          = "object"
    title         = "Error Response"
    required      = ["error", "message"]
    properties = {
      error = {
        type        = "string"
        description = "Error type"
      }
      message = {
        type        = "string"
        description = "Error message"
      }
      code = {
        type        = "string"
        description = "Error code"
      }
      type = {
        type        = "string"
        description = "Exception type"
      }
    }
  })

  depends_on = [aws_api_gateway_rest_api.athena_api]
}

# ============================================
# Lambda Integration
# ============================================

resource "aws_api_gateway_integration" "lambda_integration" {
  rest_api_id             = aws_api_gateway_rest_api.athena_api.id
  resource_id             = aws_api_gateway_resource.query_resource.id
  http_method             = aws_api_gateway_method.query_post.http_method
  type                    = "AWS_PROXY"
  integration_http_method = "POST"
  uri                     = var.lambda_function_arn != "" ? var.lambda_function_arn : "${aws_lambda_function.athena_query[0].invoke_arn}"

  # Lambda integration settings
  content_handling_strategy = "CONVERT_TO_TEXT"
  passthrough_behavior      = "WHEN_NO_MATCH"

  # Timeout for Lambda invocation
  timeout_milliseconds = 300000  # 300 seconds (max for Lambda Proxy)

  # Request mapping (not needed for AWS_PROXY)
  # request_templates = {}

  depends_on = [
    aws_api_gateway_method.query_post,
    # aws_lambda_function.athena_query,
  ]
}

# ============================================
# Lambda Permission for API Gateway
# ============================================

resource "aws_lambda_permission" "api_gateway_invoke" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = var.lambda_function_name
  principal     = "apigateway.amazonaws.com"

  # Allow invocation from this specific API
  source_arn = "${aws_api_gateway_rest_api.athena_api.execution_arn}/*/*/*"

  depends_on = [aws_api_gateway_rest_api.athena_api]
}

# ============================================
# CORS Configuration (OPTIONS Method)
# ============================================

resource "aws_api_gateway_method" "query_options" {
  count       = var.enable_cors ? 1 : 0
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  resource_id = aws_api_gateway_resource.query_resource.id
  http_method = "OPTIONS"
  authorization = "NONE"

  depends_on = [aws_api_gateway_resource.query_resource]
}

resource "aws_api_gateway_integration" "cors_integration" {
  count       = var.enable_cors ? 1 : 0
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  resource_id = aws_api_gateway_resource.query_resource.id
  http_method = aws_api_gateway_method.query_options[0].http_method
  type        = "MOCK"

  request_templates = {
    "application/json" = jsonencode({
      statusCode = 200
      headers = {
        "Access-Control-Allow-Origin"  = "'*'"
        "Access-Control-Allow-Methods"  = "'POST,OPTIONS'"
        "Access-Control-Allow-Headers"  = "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        "Access-Control-Max-Age"       = "'86400'"
      }
      body = ""
    })
  }

  depends_on = [aws_api_gateway_method.query_options]
}

resource "aws_api_gateway_method_response" "cors_response" {
  count       = var.enable_cors ? 1 : 0
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  resource_id = aws_api_gateway_resource.query_resource.id
  http_method = aws_api_gateway_method.query_options[0].http_method
  status_code = "200"

  response_parameters = {
    "method.response.header.Access-Control-Allow-Origin"  = true
    "method.response.header.Access-Control-Allow-Methods"  = true
    "method.response.header.Access-Control-Allow-Headers"  = true
    "method.response.header.Access-Control-Max-Age"       = true
  }

  depends_on = [aws_api_gateway_method.query_options]
}

resource "aws_api_gateway_integration_response" "cors_integration_response" {
  count       = var.enable_cors ? 1 : 0
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  resource_id = aws_api_gateway_resource.query_resource.id
  http_method = aws_api_gateway_method.query_options[0].http_method
  status_code = "200"

  response_parameters = {
    "method.response.header.Access-Control-Allow-Origin"  = "'*'"
    "method.response.header.Access-Control-Allow-Methods"  = "'POST,OPTIONS'"
    "method.response.header.Access-Control-Allow-Headers"  = "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
    "Access-Control-Max-Age"       = "'86400'"
  }

  depends_on = [aws_api_gateway_method_response.cors_response]
}

# ============================================
# API Gateway Deployment
# ============================================

resource "aws_api_gateway_deployment" "athena_api_deployment" {
  rest_api_id = aws_api_gateway_rest_api.athena_api.id
  stage_name  = var.api_stage_name

  # Description for this deployment
  description = "Initial deployment of ${var.api_name}"

  # Variables for the stage
  variables = {
    environment = var.api_stage_name
    deployed_at = timestamp()
  }

  # Ensure integration is created before deployment
  depends_on = [
    aws_api_gateway_integration.lambda_integration,
    aws_api_gateway_integration.cors_integration,
  ]

  # Recreate deployment when stage configuration changes
  lifecycle {
    create_before_destroy = true
  }
}

# ============================================
# API Gateway Stage
# ============================================

resource "aws_api_gateway_stage" "athena_api_stage" {
  deployment_id = aws_api_gateway_deployment.athena_api_deployment.id
  rest_api_id   = aws_api_gateway_rest_api.athena_api.id
  stage_name    = var.api_stage_name

  # Stage settings
  description = "${var.api_stage_name} stage for ${var.api_name}"
  
  # Enable access logging
  # xray_tracing_enabled = true

  # Stage variables
  variables = {
    environment = var.api_stage_name
  }

  tags = var.tags

  lifecycle {
    create_before_destroy = true
  }
}

# ============================================
# CloudWatch Logs for API Gateway
# ============================================

resource "aws_cloudwatch_log_group" "api_gateway" {
  count             = var.enable_logging ? 1 : 0
  name              = "API-Gateway-Execution-Logs_${var.api_name}/${var.api_stage_name}"
  retention_in_days = var.log_retention_days

  tags = var.tags
}

# ================================= Role for API Gateway Logging===========
# IAM
# ============================================

resource "aws_iam_role" "api_gateway_logs" {
  count       = var.enable_logging ? 1 : 0
  name        = "${var.api_name}-logs-role"
  description = "IAM role for API Gateway CloudWatch logging"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "apigateway.amazonaws.com"
        }
        Action = "sts:AssumeRole"
      }
    ]
  })

  tags = var.tags
}

resource "aws_iam_policy" "api_gateway_logs" {
  count      = var.enable_logging ? 1 : 0
  name       = "${var.api_name}-logs-policy"
  description = "Policy for API Gateway to write logs to CloudWatch"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents",
          "logs:DescribeLogStreams"
        ]
        Resource = [
          "arn:aws:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:API-Gateway-Execution-Logs_${var.api_name}/${var.api_stage_name}:*",
          "arn:aws:logs:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:log-group:API-Gateway-Execution-Logs_${var.api_name}/${var.api_stage_name}"
        ]
      }
    ]
  })

  depends_on = [aws_iam_role.api_gateway_logs]
}

resource "aws_iam_role_policy_attachment" "api_gateway_logs" {
  count      = var.enable_logging ? 1 : 0
  role       = aws_iam_role.api_gateway_logs[0].name
  policy_arn = aws_iam_policy.api_gateway_logs[0].arn

  depends_on = [aws_iam_policy.api_gateway_logs]
}

# ============================================
# Account Settings for Logging
# ============================================

resource "aws_api_gateway_account_settings" "logging" {
  count = var.enable_logging ? 1 : 0

  cloudwatch_role_arn = aws_iam_role.api_gateway_logs[0].arn
}

# ============================================
# Data Sources
# ============================================

data "aws_region" "current" {}
data "aws_caller_identity" "current" {}
data "aws_partition" "current" {}

# ============================================
# Lambda Function Data Source (for lookup)
# ============================================

data "aws_lambda_function" "athena_query" {
  count = var.lambda_function_arn != "" ? 0 : 1
  function_name = var.lambda_function_name
}

# ============================================
# Outputs
# ============================================

output "api_id" {
  description = "API Gateway ID"
  value       = aws_api_gateway_rest_api.athena_api.id
}

output "api_name" {
  description = "API Gateway name"
  value       = aws_api_gateway_rest_api.athena_api.name
}

output "api_arn" {
  description = "API Gateway ARN"
  value       = aws_api_gateway_rest_api.athena_api.arn
}

output "execution_arn" {
  description = "API Gateway execution ARN"
  value       = aws_api_gateway_rest_api.athena_api.execution_arn
}

output "invoke_url" {
  description = "URL to invoke the API"
  value       = aws_api_gateway_stage.athena_api_stage.invoke_url
}

output "query_endpoint_url" {
  description = "Full URL for the /query endpoint"
  value       = "${aws_api_gateway_stage.athena_api_stage.invoke_url}/query"
}

output "query_endpoint_arn" {
  description = "ARN for the /query endpoint"
  value       = "${aws_api_gateway_rest_api.athena_api.execution_arn}/${aws_api_gateway_stage.athena_api_stage.stage_name}/query"
}

output "stage_name" {
  description = "Deployment stage name"
  value       = var.api_stage_name
}

output "deployment_id" {
  description = "Deployment ID"
  value       = aws_api_gateway_deployment.athena_api_deployment.id
}

output "log_group_name" {
  description = "CloudWatch log group name"
  value       = var.enable_logging ? aws_cloudwatch_log_group.api_gateway[0].name : "logging-disabled"
}

output "endpoints" {
  description = "Available endpoints"
  value = {
    POST_query = "${aws_api_gateway_stage.athena_api_stage.invoke_url}/query"
    OPTIONS_query = "${aws_api_gateway_stage.athena_api_stage.invoke_url}/query (OPTIONS)"
  }
}

output "example_usage" {
  description = "Example curl command to test the API"
  value = <<EXAMPLE

========================================
API Gateway Example Usage
========================================

# Execute a SQL query
curl -X POST \\
  "${aws_api_gateway_stage.athena_api_stage.invoke_url}/query" \\
  -H 'Content-Type: application/json' \\
  -d '{"query": "SELECT * FROM student_db LIMIT 10"}'

# Expected response:
{
  "message": "Query executed successfully",
  "queryExecutionId": "abc123-def456",
  "state": "SUCCEEDED",
  "rows": [...],
  "columnMetadata": [...],
  "rowCount": 5
}

========================================
EXAMPLE
}

output "api_gateway_url" {
  description = "Base API Gateway URL"
  value       = aws_api_gateway_stage.athena_api_stage.invoke_url
}

